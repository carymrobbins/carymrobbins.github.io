<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Overriding Type Class Instances (Part 2)</title>

    <!-- components -->
    <link rel="stylesheet" type="text/css" href="../../components/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../components/font-awesome/css/font-awesome.css" />
    <link rel="stylesheet" type="text/css" href="../../components/bootstrap-social/bootstrap-social.css" />

    <!-- google fonts -->
    <link href="https://fonts.googleapis.com/css?family=Merriweather" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Noto+Serif:400,700" rel="stylesheet" type="text/css">

    <!-- assets -->
    <link rel="stylesheet" type="text/css" href="../../css/default.css" />
    <link rel="stylesheet" type="text/css" href="../../css/pygments.css" />

  </head>
  <body>
    <nav id="header" class="navbar navbar-default navbar-static-top">
      <div class="container">
        <div class="row">
          <div id="logo" class="col-md-6">
            <a href="../../">cary robbins</a>
          </div>
          <div id="social" class="col-md-6">
            <a title="github" href="https://github.com/carymrobbins" class="btn btn-social-icon btn-github">
              <span class="fa fa-github"></span>
            </a>
            <a title="linkedin" href="https://www.linkedin.com/in/carymrobbins" class="btn btn-social-icon btn-linkedin">
              <span class="fa fa-linkedin"></span>
            </a>
            <a title="twitter" href="https://twitter.com/carymrobbins" class="btn btn-social-icon btn-twitter">
              <span class="fa fa-twitter"></span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div class="content">
      <div class="container">
  <div class="row">
    <div class="col-md-12">
      <h1>Overriding Type Class Instances (Part 2)</h1>
    </div>
    <div class="col-md-12">
      <small>March 25, 2020</small>
    </div>
  </div>
  <hr />
  <div class="row">
    <div class="col-md-12">
      <p>As we discovered in <a href="../overriding-type-class-instances/">part 1</a>, we can build some infrastructure to override instances for a type class we’ve created. But what if we want to do this for an existing type class? In most cases, we likely won’t be able to tamper with the source code to inject our override machinery. Furthermore, we’d like to be able to achieve this with as little boilerplate as possible.</p>
<h2 id="spoiler-alert">Spoiler Alert</h2>
<p>The goal I set out to acheive was to end up with the following syntax. Note that this allows us to override type class instances by type or field name.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">import</span> <span class="dt">Data.Aeson</span> (<span class="dt">ToJSON</span>)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">import</span> <span class="dt">Data.Override</span> (<span class="dt">Override</span>(<span class="dt">Override</span>), <span class="dt">As</span>)</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Override</span> <span class="kw">as</span> <span class="dt">Override</span></a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">data</span> <span class="dt">MyRec</span> <span class="fu">=</span> <span class="dt">MyRec</span></a>
<a class="sourceLine" id="cb1-6" title="6">  {<span class="ot"> foo ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb1-7" title="7">  ,<span class="ot"> bar ::</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb1-8" title="8">  ,<span class="ot"> baz ::</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb1-9" title="9">  } <span class="kw">deriving</span> stock (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Generic</span>)</a>
<a class="sourceLine" id="cb1-10" title="10">    <span class="kw">deriving</span> (<span class="dt">ToJSON</span>)</a>
<a class="sourceLine" id="cb1-11" title="11">      via <span class="dt">Override</span> <span class="dt">MyRec</span></a>
<a class="sourceLine" id="cb1-12" title="12">            '[ <span class="dt">String</span> <span class="ot">`As`</span> <span class="dt">CharArray</span></a>
<a class="sourceLine" id="cb1-13" title="13">             , <span class="st">&quot;baz&quot;</span> <span class="ot">`As`</span> <span class="dt">Uptext</span></a>
<a class="sourceLine" id="cb1-14" title="14">             ]</a></code></pre></div>
<p>The idea is that we can piggyback off of the existing generic machinery used by <code>ToJSON</code>. We will use <code>DerivingVia</code> to derive an instance of <code>ToJSON MyRec</code> via <code>Override MyRec</code> with a type-level list specifying the type substitutions to make.</p>
<p>In our example, we are saying that when deriving a <code>ToJSON MyRec</code> instance, for its fields, instead of <code>ToJSON String</code> use <code>ToJSON CharArray</code> and, for the <code>baz</code> field, instead of <code>ToJSON Text</code> use <code>ToJSON Uptext</code>. These alternate instances will be provided via newtype wrappers, something we’re likely all familiar with at this point.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">newtype</span> <span class="dt">Uptext</span> <span class="fu">=</span> <span class="dt">Uptext</span> {<span class="ot"> unUptext ::</span> <span class="dt">Text</span> }</a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">instance</span> <span class="dt">ToJSON</span> <span class="dt">Uptext</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-4" title="4">  toJSON <span class="fu">=</span> toJSON <span class="fu">.</span> Text.toUpper <span class="fu">.</span> unUptext</a>
<a class="sourceLine" id="cb2-5" title="5"></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="kw">newtype</span> <span class="dt">CharArray</span> <span class="fu">=</span> <span class="dt">CharArray</span> {<span class="ot"> unCharArray ::</span> <span class="dt">String</span> }</a>
<a class="sourceLine" id="cb2-7" title="7"></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="kw">instance</span> <span class="dt">ToJSON</span> <span class="dt">CharArray</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-9" title="9">  toJSON <span class="fu">=</span> toJSON <span class="fu">.</span> <span class="fu">map</span> (<span class="fu">:</span>[]) <span class="fu">.</span> unCharArray</a></code></pre></div>
<p>Now, via the derived <code>ToJSON MyRec</code> instance, we should be able to serialize this Haskell value -</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="dt">MyRec</span></a>
<a class="sourceLine" id="cb3-2" title="2">  { foo <span class="fu">=</span> <span class="dv">12</span></a>
<a class="sourceLine" id="cb3-3" title="3">  , bar <span class="fu">=</span> <span class="st">&quot;hi&quot;</span></a>
<a class="sourceLine" id="cb3-4" title="4">  , baz <span class="fu">=</span> <span class="st">&quot;bye&quot;</span></a>
<a class="sourceLine" id="cb3-5" title="5">  }</a></code></pre></div>
<p>into this JSON -</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb4-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb4-2" title="2">  <span class="dt">&quot;foo&quot;</span><span class="fu">:</span> <span class="dv">12</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-3" title="3">  <span class="dt">&quot;bar&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;h&quot;</span><span class="ot">,</span> <span class="st">&quot;i&quot;</span><span class="ot">]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-4" title="4">  <span class="dt">&quot;baz&quot;</span><span class="fu">:</span> <span class="st">&quot;BYE&quot;</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="fu">}</span></a></code></pre></div>
<p>Ok, now on to making this dream come true.</p>
<h2 id="the-approach">The Approach</h2>
<p>How can we possibly make this work for any type class? Well let us consider how generic derivation works in the first place.</p>
<p>The <code>ToJSON</code> type class delegates to <code>genericToJSON</code> for its default implementation -</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" title="1"><span class="ot">toJSON ::</span> a <span class="ot">-&gt;</span> <span class="dt">Value</span></a>
<a class="sourceLine" id="cb5-2" title="2">toJSON <span class="fu">=</span> genericToJSON defaultOptions</a></code></pre></div>
<p>It’s not too important to know the implementation of <code>genericToJSON</code> for our uses, so we’ll just worry about its type signature.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" title="1">genericToJSON</a>
<a class="sourceLine" id="cb6-2" title="2"><span class="ot">  ::</span> (<span class="dt">Generic</span> a, <span class="dt">GToJSON</span> <span class="dt">Value</span> <span class="dt">Zero</span> (<span class="dt">Rep</span> a))</a>
<a class="sourceLine" id="cb6-3" title="3">  <span class="ot">=&gt;</span> <span class="dt">Options</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Value</span></a></code></pre></div>
<p>So it has its own generic version of <code>ToJSON</code> called <code>GToJSON</code> which operates on <code>Rep</code> values. <code>Rep</code> is an associated type family introduced by the <code>Generic</code> type class which tells us the generic representation of its type argument.</p>
<p>To give a concrete example, we can observe the generic representation type for our <code>MyRec</code> type from earlier using <code>GHC.Generics.from</code> -</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" title="1"><span class="fu">%</span> ghci</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="fu">&gt;</span> <span class="fu">:</span>t from</a>
<a class="sourceLine" id="cb7-3" title="3"><span class="ot">from ::</span> <span class="dt">Generic</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Rep</span> a x</a>
<a class="sourceLine" id="cb7-4" title="4"></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="fu">&gt;</span> <span class="fu">:</span>t from <span class="dt">MyRec</span> { foo <span class="fu">=</span> <span class="dv">1</span>, bar <span class="fu">=</span> <span class="st">&quot;hi&quot;</span>, baz <span class="fu">=</span> <span class="st">&quot;bye&quot;</span> }</a>
<a class="sourceLine" id="cb7-6" title="6">from <span class="dt">MyRec</span> { foo <span class="fu">=</span> <span class="dv">1</span>, bar <span class="fu">=</span> <span class="st">&quot;hi&quot;</span>, baz <span class="fu">=</span> <span class="st">&quot;bye&quot;</span> }</a>
<a class="sourceLine" id="cb7-7" title="7"><span class="ot">  ::</span> <span class="dt">D1</span></a>
<a class="sourceLine" id="cb7-8" title="8">       (<span class="dt">'MetaData</span> <span class="st">&quot;MyRec&quot;</span> <span class="st">&quot;Ghci1&quot;</span> <span class="st">&quot;interactive&quot;</span> <span class="dt">'False</span>)</a>
<a class="sourceLine" id="cb7-9" title="9">       (<span class="dt">C1</span></a>
<a class="sourceLine" id="cb7-10" title="10">          (<span class="dt">'MetaCons</span> <span class="st">&quot;MyRec&quot;</span> <span class="dt">'PrefixI</span> <span class="dt">'True</span>)</a>
<a class="sourceLine" id="cb7-11" title="11">          (<span class="dt">S1</span></a>
<a class="sourceLine" id="cb7-12" title="12">             (<span class="dt">'MetaSel</span></a>
<a class="sourceLine" id="cb7-13" title="13">                (<span class="dt">'Just</span> <span class="st">&quot;foo&quot;</span>)</a>
<a class="sourceLine" id="cb7-14" title="14">                <span class="dt">'NoSourceUnpackedness</span></a>
<a class="sourceLine" id="cb7-15" title="15">                <span class="dt">'NoSourceStrictness</span></a>
<a class="sourceLine" id="cb7-16" title="16">                <span class="dt">'DecidedLazy</span>)</a>
<a class="sourceLine" id="cb7-17" title="17">             (<span class="dt">Rec0</span> <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb7-18" title="18">           <span class="fu">:*:</span> (<span class="dt">S1</span></a>
<a class="sourceLine" id="cb7-19" title="19">                  (<span class="dt">'MetaSel</span></a>
<a class="sourceLine" id="cb7-20" title="20">                     (<span class="dt">'Just</span> <span class="st">&quot;bar&quot;</span>)</a>
<a class="sourceLine" id="cb7-21" title="21">                     <span class="dt">'NoSourceUnpackedness</span></a>
<a class="sourceLine" id="cb7-22" title="22">                     <span class="dt">'NoSourceStrictness</span></a>
<a class="sourceLine" id="cb7-23" title="23">                     <span class="dt">'DecidedLazy</span>)</a>
<a class="sourceLine" id="cb7-24" title="24">                  (<span class="dt">Rec0</span> <span class="dt">String</span>)</a>
<a class="sourceLine" id="cb7-25" title="25">                <span class="fu">:*:</span> <span class="dt">S1</span></a>
<a class="sourceLine" id="cb7-26" title="26">                      (<span class="dt">'MetaSel</span></a>
<a class="sourceLine" id="cb7-27" title="27">                         (<span class="dt">'Just</span> <span class="st">&quot;baz&quot;</span>)</a>
<a class="sourceLine" id="cb7-28" title="28">                         <span class="dt">'NoSourceUnpackedness</span></a>
<a class="sourceLine" id="cb7-29" title="29">                         <span class="dt">'NoSourceStrictness</span></a>
<a class="sourceLine" id="cb7-30" title="30">                         <span class="dt">'DecidedLazy</span>)</a>
<a class="sourceLine" id="cb7-31" title="31">                      (<span class="dt">Rec0</span> <span class="dt">Text</span>))))</a>
<a class="sourceLine" id="cb7-32" title="32">       x</a></code></pre></div>
<p>A bit noisy, but you can see that the structure of our <code>MyRec</code> type is represented here.</p>
<h3 id="heres-the-important-part">Here’s the important part!</h3>
<p>What we can do is create our own type class that will produce a different representation when we are passing things through our <code>Override</code> type. We can replace the leaves of the generic representation with another type that will do the override magic for us. We’ll call this type <code>Overridden</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" title="1"><span class="fu">%</span> ghci</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="fu">&gt;</span> <span class="fu">:</span>{</a>
<a class="sourceLine" id="cb8-3" title="3"><span class="ot">   r ::</span> <span class="dt">Override</span> <span class="dt">MyRec</span> '[<span class="dt">String</span> <span class="ot">`As`</span> <span class="dt">CharArray</span>]</a>
<a class="sourceLine" id="cb8-4" title="4">   r <span class="fu">=</span> <span class="dt">Override</span> <span class="dt">MyRec</span> { foo <span class="fu">=</span> <span class="dv">1</span>, bar <span class="fu">=</span> <span class="st">&quot;hi&quot;</span>, baz <span class="fu">=</span> <span class="st">&quot;bye&quot;</span> }</a>
<a class="sourceLine" id="cb8-5" title="5">  <span class="fu">:</span>}</a>
<a class="sourceLine" id="cb8-6" title="6"></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="fu">&gt;</span> <span class="fu">:</span>t from r</a>
<a class="sourceLine" id="cb8-8" title="8">from r</a>
<a class="sourceLine" id="cb8-9" title="9"><span class="ot">  ::</span> <span class="dt">M1</span></a>
<a class="sourceLine" id="cb8-10" title="10">       <span class="dt">D</span></a>
<a class="sourceLine" id="cb8-11" title="11">       (<span class="dt">'MetaData</span> <span class="st">&quot;MyRec&quot;</span> <span class="st">&quot;Ghci1&quot;</span> <span class="st">&quot;interactive&quot;</span> <span class="dt">'False</span>)</a>
<a class="sourceLine" id="cb8-12" title="12">       (<span class="dt">M1</span></a>
<a class="sourceLine" id="cb8-13" title="13">          <span class="dt">C</span></a>
<a class="sourceLine" id="cb8-14" title="14">          (<span class="dt">'MetaCons</span> <span class="st">&quot;MyRec&quot;</span> <span class="dt">'PrefixI</span> <span class="dt">'True</span>)</a>
<a class="sourceLine" id="cb8-15" title="15">          (<span class="dt">M1</span></a>
<a class="sourceLine" id="cb8-16" title="16">             <span class="dt">S</span></a>
<a class="sourceLine" id="cb8-17" title="17">             (<span class="dt">'MetaSel</span></a>
<a class="sourceLine" id="cb8-18" title="18">                (<span class="dt">'Just</span> <span class="st">&quot;foo&quot;</span>)</a>
<a class="sourceLine" id="cb8-19" title="19">                <span class="dt">'NoSourceUnpackedness</span></a>
<a class="sourceLine" id="cb8-20" title="20">                <span class="dt">'NoSourceStrictness</span></a>
<a class="sourceLine" id="cb8-21" title="21">                <span class="dt">'DecidedLazy</span>)</a>
<a class="sourceLine" id="cb8-22" title="22">             (<span class="dt">K1</span> <span class="dt">R</span> (<span class="dt">Overridden</span> (<span class="dt">'Just</span> <span class="st">&quot;foo&quot;</span>) <span class="dt">Int</span> '[<span class="dt">As</span> <span class="dt">String</span> <span class="dt">CharArray</span>]))</a>
<a class="sourceLine" id="cb8-23" title="23">           <span class="fu">:*:</span> (<span class="dt">M1</span></a>
<a class="sourceLine" id="cb8-24" title="24">                  <span class="dt">S</span></a>
<a class="sourceLine" id="cb8-25" title="25">                  (<span class="dt">'MetaSel</span></a>
<a class="sourceLine" id="cb8-26" title="26">                     (<span class="dt">'Just</span> <span class="st">&quot;bar&quot;</span>)</a>
<a class="sourceLine" id="cb8-27" title="27">                     <span class="dt">'NoSourceUnpackedness</span></a>
<a class="sourceLine" id="cb8-28" title="28">                     <span class="dt">'NoSourceStrictness</span></a>
<a class="sourceLine" id="cb8-29" title="29">                     <span class="dt">'DecidedLazy</span>)</a>
<a class="sourceLine" id="cb8-30" title="30">                  (<span class="dt">K1</span> <span class="dt">R</span> (<span class="dt">Overridden</span> (<span class="dt">'Just</span> <span class="st">&quot;bar&quot;</span>) [<span class="dt">Char</span>] '[<span class="dt">As</span> <span class="dt">String</span> <span class="dt">CharArray</span>]))</a>
<a class="sourceLine" id="cb8-31" title="31">                <span class="fu">:*:</span> <span class="dt">M1</span></a>
<a class="sourceLine" id="cb8-32" title="32">                      <span class="dt">S</span></a>
<a class="sourceLine" id="cb8-33" title="33">                      (<span class="dt">'MetaSel</span></a>
<a class="sourceLine" id="cb8-34" title="34">                         (<span class="dt">'Just</span> <span class="st">&quot;baz&quot;</span>)</a>
<a class="sourceLine" id="cb8-35" title="35">                         <span class="dt">'NoSourceUnpackedness</span></a>
<a class="sourceLine" id="cb8-36" title="36">                         <span class="dt">'NoSourceStrictness</span></a>
<a class="sourceLine" id="cb8-37" title="37">                         <span class="dt">'DecidedLazy</span>)</a>
<a class="sourceLine" id="cb8-38" title="38">                      (<span class="dt">K1</span> <span class="dt">R</span> (<span class="dt">Overridden</span> (<span class="dt">'Just</span> <span class="st">&quot;baz&quot;</span>) <span class="dt">Text</span> '[<span class="dt">As</span> <span class="dt">String</span> <span class="dt">CharArray</span>])))))</a>
<a class="sourceLine" id="cb8-39" title="39">       x</a></code></pre></div>
<p>As you can see, the leaf nodes of our generic representation have now been tagged as <code>Overridden</code> and include the field name, underlying type, and type-level list of overrides.</p>
<h2 id="making-it-really-work-for-real">Making it really work for real</h2>
<p>First, we’ll need to define the types needed for this syntax.</p>
<p>The <em>entry point</em> for our generic override machinery will be the <code>Override</code> newtype.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">newtype</span> <span class="dt">Override</span> a (<span class="ot">xs ::</span> [<span class="fu">*</span>]) <span class="fu">=</span> <span class="dt">Override</span> {<span class="ot"> unOverride ::</span> a }</a></code></pre></div>
<p>This takes two type parameters -</p>
<ul>
<li><code>a</code> - The type which contains fields for which we will be overriding instances during generic derivation</li>
<li><code>xs</code> - A type-level list of overrides</li>
</ul>
<p>Next, we need to define the <code>As</code> type which can be conveniently used infix via <code>TypeOperators</code>. This is similar to how it was defined in part 1 except this time it uses <code>PolyKinds</code> so we can target either a concrete type or a field name to override.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">data</span> <span class="dt">As</span> (<span class="ot">o ::</span> k) n</a></code></pre></div>
<p>This takes two type parameters -</p>
<ul>
<li><code>o</code> - The target to be overridden. Should be either the concrete type to or field name to override.</li>
<li><code>n</code> - The type to replace <code>o</code> with.</li>
</ul>
<p>Now we’ll create the <code>Overridden</code> type used at the leaf nodes of the generic representation of an <code>Override</code> type.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">newtype</span> <span class="dt">Overridden</span> (<span class="ot">ms ::</span> <span class="dt">Maybe</span> <span class="dt">Symbol</span>) a (<span class="ot">xs ::</span> [<span class="fu">*</span>]) <span class="fu">=</span></a>
<a class="sourceLine" id="cb11-2" title="2">  <span class="dt">Overridden</span> {<span class="ot"> unOverridden ::</span> a }</a></code></pre></div>
<p>This has the same type parameters as <code>Override</code> except for <code>ms</code>. The <code>ms</code> holds an optional type-level string which, when available, will contain the field name for a leaf node we can override.</p>
<p>We’ll also need to introduce a type family called <code>Using</code> which will be used to “pick” which instance to use from a list of overrides.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">import</span> <span class="dt">Data.Type.Bool</span> (<span class="dt">If</span>)</a>
<a class="sourceLine" id="cb12-2" title="2"><span class="kw">import</span> <span class="dt">Data.Type.Equality</span> (type (==))</a>
<a class="sourceLine" id="cb12-3" title="3"></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="kw">type</span> <span class="kw">family</span> <span class="dt">Using</span> (<span class="ot">ms ::</span> <span class="dt">Maybe</span> <span class="dt">Symbol</span>) (<span class="ot">x ::</span> <span class="fu">*</span>) (<span class="ot">xs ::</span> [<span class="fu">*</span>]) <span class="kw">where</span></a>
<a class="sourceLine" id="cb12-5" title="5">  <span class="co">-- No matching override found.</span></a>
<a class="sourceLine" id="cb12-6" title="6">  <span class="dt">Using</span> ms x '[] <span class="fu">=</span> x</a>
<a class="sourceLine" id="cb12-7" title="7"></a>
<a class="sourceLine" id="cb12-8" title="8">  <span class="co">-- Override the matching field.</span></a>
<a class="sourceLine" id="cb12-9" title="9">  <span class="dt">Using</span> ms x (<span class="dt">As</span> (<span class="ot">o ::</span> <span class="dt">Symbol</span>) n '<span class="fu">:</span> xs) <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-10" title="10">    <span class="dt">If</span> (ms <span class="fu">==</span> <span class="dt">'Just</span> o) n (<span class="dt">Using</span> ms x xs)</a>
<a class="sourceLine" id="cb12-11" title="11"></a>
<a class="sourceLine" id="cb12-12" title="12">  <span class="co">-- Override the matching type.</span></a>
<a class="sourceLine" id="cb12-13" title="13">  <span class="dt">Using</span> ms x (<span class="dt">As</span> (<span class="ot">o ::</span> <span class="fu">*</span>) n '<span class="fu">:</span> xs) <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-14" title="14">    <span class="dt">If</span> (x <span class="fu">==</span> o) n (<span class="dt">Using</span> ms x xs)</a></code></pre></div>
<p>The use of <code>PolyKinds</code> with our <code>As</code> type allows us to override by <code>Symbol</code> or concrete type. The <code>ms</code> and <code>x</code> supplied to <code>Using</code> will be the same <code>Maybe Symbol</code> and <code>a</code> as from <code>Overridden</code>. This allows us to conditionally match on the field name or type.</p>
<h3 id="goverride">GOverride</h3>
<p>In order for us to build our own <code>Rep</code> for our <code>Override</code> type (instead of relying on the one provided by GHC) we’ll need to introduce a new type class.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">class</span> <span class="dt">GOverride</span> (<span class="ot">xs ::</span> [<span class="fu">*</span>]) (<span class="ot">f ::</span> <span class="fu">*</span> <span class="ot">-&gt;</span> <span class="fu">*</span>) <span class="kw">where</span></a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="kw">type</span> <span class="dt">OverrideRep</span> xs<span class="ot"> f ::</span> <span class="fu">*</span> <span class="ot">-&gt;</span> <span class="fu">*</span></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="ot">  overrideFrom ::</span> f x <span class="ot">-&gt;</span> <span class="dt">OverrideRep</span> xs f x</a>
<a class="sourceLine" id="cb13-4" title="4"><span class="ot">  overrideTo ::</span> <span class="dt">OverrideRep</span> xs f x <span class="ot">-&gt;</span> f x</a></code></pre></div>
<p>The <code>OverrideRep</code> is analogous to the <code>Rep</code> from <code>GHC.Generics</code>, except it takes a <code>Rep</code> and produces a new one which has <code>Overridden</code> injected at its leaves. The same goes for <code>overrideFrom</code> and <code>overrideTo</code>, which are analogous to <code>from</code> and <code>to</code> from <code>GHC.Generics</code> but perform runtime injection of <code>Overridden</code> at the leaves of the generic representation.</p>
<p>We can then define the instance for <code>Generic Override</code> as follows, delegating to our <code>GOverride</code> type class.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">instance</span> (<span class="dt">Generic</span> a, <span class="dt">GOverride</span> xs (<span class="dt">Rep</span> a)) <span class="ot">=&gt;</span> <span class="dt">Generic</span> (<span class="dt">Override</span> a xs) <span class="kw">where</span></a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="kw">type</span> <span class="dt">Rep</span> (<span class="dt">Override</span> a xs) <span class="fu">=</span> <span class="dt">OverrideRep</span> xs (<span class="dt">Rep</span> a)</a>
<a class="sourceLine" id="cb14-3" title="3">  from <span class="fu">=</span> overrideFrom <span class="fu">@</span>xs <span class="fu">.</span> from <span class="fu">.</span> unOverride</a>
<a class="sourceLine" id="cb14-4" title="4">  to <span class="fu">=</span> <span class="dt">Override</span> <span class="fu">.</span> to <span class="fu">.</span> overrideTo <span class="fu">@</span>xs</a></code></pre></div>
<p>We can then define instances for <code>GOverride</code> which operate on the generic representation nodes -</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">instance</span> (<span class="dt">GOverride</span> xs f) <span class="ot">=&gt;</span> <span class="dt">GOverride</span> xs (<span class="dt">M1</span> <span class="dt">D</span> c f) <span class="kw">where</span></a>
<a class="sourceLine" id="cb15-2" title="2">  <span class="kw">type</span> <span class="dt">OverrideRep</span> xs (<span class="dt">M1</span> <span class="dt">D</span> c f) <span class="fu">=</span> <span class="dt">M1</span> <span class="dt">D</span> c (<span class="dt">OverrideRep</span> xs f)</a>
<a class="sourceLine" id="cb15-3" title="3">  overrideFrom (<span class="dt">M1</span> x) <span class="fu">=</span> <span class="dt">M1</span> (overrideFrom <span class="fu">@</span>xs x)</a>
<a class="sourceLine" id="cb15-4" title="4">  overrideTo (<span class="dt">M1</span> x) <span class="fu">=</span> <span class="dt">M1</span> (overrideTo <span class="fu">@</span>xs x)</a>
<a class="sourceLine" id="cb15-5" title="5"></a>
<a class="sourceLine" id="cb15-6" title="6"><span class="kw">instance</span> (<span class="dt">GOverride</span> xs f) <span class="ot">=&gt;</span> <span class="dt">GOverride</span> xs (<span class="dt">M1</span> <span class="dt">C</span> c f) <span class="kw">where</span></a>
<a class="sourceLine" id="cb15-7" title="7">  <span class="kw">type</span> <span class="dt">OverrideRep</span> xs (<span class="dt">M1</span> <span class="dt">C</span> c f) <span class="fu">=</span> <span class="dt">M1</span> <span class="dt">C</span> c (<span class="dt">OverrideRep</span> xs f)</a>
<a class="sourceLine" id="cb15-8" title="8">  overrideFrom (<span class="dt">M1</span> x) <span class="fu">=</span> <span class="dt">M1</span> (overrideFrom <span class="fu">@</span>xs x)</a>
<a class="sourceLine" id="cb15-9" title="9">  overrideTo (<span class="dt">M1</span> x) <span class="fu">=</span> <span class="dt">M1</span> (overrideTo <span class="fu">@</span>xs x)</a>
<a class="sourceLine" id="cb15-10" title="10"></a>
<a class="sourceLine" id="cb15-11" title="11"><span class="kw">instance</span> (<span class="dt">GOverride</span> xs f, <span class="dt">GOverride</span> xs g) <span class="ot">=&gt;</span> <span class="dt">GOverride</span> xs (f <span class="fu">:*:</span> g) <span class="kw">where</span></a>
<a class="sourceLine" id="cb15-12" title="12">  <span class="kw">type</span> <span class="dt">OverrideRep</span> xs (f <span class="fu">:*:</span> g) <span class="fu">=</span> <span class="dt">OverrideRep</span> xs f <span class="fu">:*:</span> <span class="dt">OverrideRep</span> xs g</a>
<a class="sourceLine" id="cb15-13" title="13">  overrideFrom (f <span class="fu">:*:</span> g) <span class="fu">=</span> overrideFrom <span class="fu">@</span>xs f <span class="fu">:*:</span> overrideFrom <span class="fu">@</span>xs g</a>
<a class="sourceLine" id="cb15-14" title="14">  overrideTo (f <span class="fu">:*:</span> g) <span class="fu">=</span> overrideTo <span class="fu">@</span>xs f <span class="fu">:*:</span> overrideTo <span class="fu">@</span>xs g</a>
<a class="sourceLine" id="cb15-15" title="15"></a>
<a class="sourceLine" id="cb15-16" title="16"><span class="co">-- Instance for selecting a field.</span></a>
<a class="sourceLine" id="cb15-17" title="17"><span class="co">-- * 'ms' is a 'Maybe Symbol' containing the field name, if applicable.</span></a>
<a class="sourceLine" id="cb15-18" title="18"><span class="co">-- * 'su' is unused but passed through; short for 'SourceUnpackedness'</span></a>
<a class="sourceLine" id="cb15-19" title="19"><span class="co">-- * 'ss' is unused but passed through; short for 'SourceStrictness'</span></a>
<a class="sourceLine" id="cb15-20" title="20"><span class="co">-- * 'ds' is unused but passed through; short for 'DecidedStrictness'</span></a>
<a class="sourceLine" id="cb15-21" title="21"><span class="co">-- * 'c' is the type of the field.</span></a>
<a class="sourceLine" id="cb15-22" title="22"><span class="kw">instance</span> <span class="dt">GOverride</span> xs (<span class="dt">M1</span> <span class="dt">S</span> (<span class="dt">'MetaSel</span> ms su ss ds) (<span class="dt">K1</span> <span class="dt">R</span> c)) <span class="kw">where</span></a>
<a class="sourceLine" id="cb15-23" title="23">  <span class="kw">type</span> <span class="dt">OverrideRep</span> xs (<span class="dt">M1</span> <span class="dt">S</span> (<span class="dt">'MetaSel</span> ms su ss ds) (<span class="dt">K1</span> <span class="dt">R</span> c)) <span class="fu">=</span></a>
<a class="sourceLine" id="cb15-24" title="24">    <span class="dt">M1</span> <span class="dt">S</span> (<span class="dt">'MetaSel</span> ms su ss ds) (<span class="dt">K1</span> <span class="dt">R</span> (<span class="dt">Overridden</span> ms c xs))</a>
<a class="sourceLine" id="cb15-25" title="25">  overrideFrom (<span class="dt">M1</span> (<span class="dt">K1</span> x)) <span class="fu">=</span> <span class="dt">M1</span> (<span class="dt">K1</span> (<span class="dt">Overridden</span> <span class="fu">@</span>ms x))</a>
<a class="sourceLine" id="cb15-26" title="26">  overrideTo (<span class="dt">M1</span> (<span class="dt">K1</span> (<span class="dt">Overridden</span> x))) <span class="fu">=</span> <span class="dt">M1</span> (<span class="dt">K1</span> x)</a></code></pre></div>
<p>That last instance is probably the most important. We extract both the <code>M1 S</code> and <code>K1</code> so we can supply the optional field name <code>ms</code> and field type <code>c</code> to <code>Overridden</code>.</p>
<h2 id="aeson-glue">Aeson Glue</h2>
<p>Now we’ll talk about writing <em>glue code</em> which binds our generic override machinery to the aeson library, specifically, the <code>ToJSON</code> type class.</p>
<p>As previously mentioned, <code>ToJSON</code> uses <code>genericToJSON</code> for generic derivation -</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" title="1">genericToJSON</a>
<a class="sourceLine" id="cb16-2" title="2"><span class="ot">  ::</span> (<span class="dt">Generic</span> a, <span class="dt">GToJSON</span> <span class="dt">Value</span> <span class="dt">Zero</span> (<span class="dt">Rep</span> a))</a>
<a class="sourceLine" id="cb16-3" title="3">  <span class="ot">=&gt;</span> <span class="dt">Options</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Value</span></a></code></pre></div>
<p>It has another function, <code>toEncoding</code>, which is generically derived with, you guessed it, <code>genericToEncoding</code> -</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" title="1">genericToEncoding</a>
<a class="sourceLine" id="cb17-2" title="2"><span class="ot">  ::</span> (<span class="dt">Generic</span> a, <span class="dt">GToJSON</span> <span class="dt">Encoding</span> <span class="dt">Zero</span> (<span class="dt">Rep</span> a))</a>
<a class="sourceLine" id="cb17-3" title="3">  <span class="ot">=&gt;</span> <span class="dt">Options</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Encoding</span></a></code></pre></div>
<p>So we can now write an instance for <code>ToJSON Override</code> which leverages the default implementations for <code>ToJSON</code> -</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb18-1" title="1"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Aeson</span> <span class="kw">as</span> <span class="dt">Aeson</span></a>
<a class="sourceLine" id="cb18-2" title="2"></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="kw">instance</span></a>
<a class="sourceLine" id="cb18-4" title="4">  ( <span class="dt">Generic</span> (<span class="dt">Override</span> a xs)</a>
<a class="sourceLine" id="cb18-5" title="5">  , <span class="dt">Aeson.GToJSON</span> <span class="dt">Aeson.Zero</span> (<span class="dt">Rep</span> (<span class="dt">Override</span> a xs))</a>
<a class="sourceLine" id="cb18-6" title="6">  , <span class="dt">Aeson.GToEncoding</span> <span class="dt">Aeson.Zero</span> (<span class="dt">Rep</span> (<span class="dt">Override</span> a xs))</a>
<a class="sourceLine" id="cb18-7" title="7">  ) <span class="ot">=&gt;</span> <span class="dt">Aeson.ToJSON</span> (<span class="dt">Override</span> a xs)</a></code></pre></div>
<p>In this case, we don’t have to implement the <code>toJSON</code> and <code>toEncoding</code> methods; the default implementations are exactly what we would have written.</p>
<p>Next we’ll need to implement the instance for the <code>Overridden</code> type which was injected at the leaves of our generic representation.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb19-1" title="1"><span class="kw">instance</span></a>
<a class="sourceLine" id="cb19-2" title="2">  ( <span class="dt">Coercible</span> a (<span class="dt">Using</span> ms a xs)</a>
<a class="sourceLine" id="cb19-3" title="3">  , <span class="dt">Aeson.ToJSON</span> (<span class="dt">Using</span> ms a xs)</a>
<a class="sourceLine" id="cb19-4" title="4">  ) <span class="ot">=&gt;</span> <span class="dt">Aeson.ToJSON</span> (<span class="dt">Overridden</span> ms a xs)</a>
<a class="sourceLine" id="cb19-5" title="5">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb19-6" title="6">  toJSON <span class="fu">=</span> Aeson.toJSON <span class="fu">@</span>(<span class="dt">Using</span> ms a xs) <span class="fu">.</span> coerce</a>
<a class="sourceLine" id="cb19-7" title="7">  toEncoding <span class="fu">=</span> Aeson.toEncoding <span class="fu">@</span>(<span class="dt">Using</span> ms a xs) <span class="fu">.</span> coerce</a></code></pre></div>
<p>And that’s it! We now have generic override support for <code>ToJSON</code>!</p>
<h2 id="exploring-overrides">Exploring Overrides</h2>
<p>Let’s revisit our original <code>MyRec</code> declaration.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb20-1" title="1"><span class="kw">data</span> <span class="dt">MyRec</span> <span class="fu">=</span> <span class="dt">MyRec</span></a>
<a class="sourceLine" id="cb20-2" title="2">  {<span class="ot"> foo ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb20-3" title="3">  ,<span class="ot"> bar ::</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb20-4" title="4">  ,<span class="ot"> baz ::</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb20-5" title="5">  } <span class="kw">deriving</span> stock (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Generic</span>)</a>
<a class="sourceLine" id="cb20-6" title="6">    <span class="kw">deriving</span> (<span class="dt">ToJSON</span>)</a>
<a class="sourceLine" id="cb20-7" title="7">      via <span class="dt">Override</span> <span class="dt">MyRec</span></a>
<a class="sourceLine" id="cb20-8" title="8">            '[ <span class="dt">String</span> <span class="ot">`As`</span> <span class="dt">CharArray</span></a>
<a class="sourceLine" id="cb20-9" title="9">             , <span class="st">&quot;baz&quot;</span> <span class="ot">`As`</span> <span class="dt">Uptext</span></a>
<a class="sourceLine" id="cb20-10" title="10">             ]</a></code></pre></div>
<p>Now let’s print out its JSON representation.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb21-1" title="1"><span class="fu">%</span> ghci</a>
<a class="sourceLine" id="cb21-2" title="2"><span class="fu">&gt;</span> enc <span class="fu">=</span> Data.ByteString.Lazy.Char8.putStrLn <span class="fu">.</span> Data.Aeson.Encode.Pretty.encodePretty</a>
<a class="sourceLine" id="cb21-3" title="3"><span class="fu">&gt;</span> enc <span class="dt">MyRec</span> { foo <span class="fu">=</span> <span class="dv">1</span>, bar <span class="fu">=</span> <span class="st">&quot;hi&quot;</span>, baz <span class="fu">=</span> <span class="st">&quot;bye&quot;</span> }</a>
<a class="sourceLine" id="cb21-4" title="4">{</a>
<a class="sourceLine" id="cb21-5" title="5">    <span class="st">&quot;foo&quot;</span><span class="fu">:</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb21-6" title="6">    <span class="st">&quot;baz&quot;</span><span class="fu">:</span> <span class="st">&quot;BYE&quot;</span>,</a>
<a class="sourceLine" id="cb21-7" title="7">    <span class="st">&quot;bar&quot;</span><span class="fu">:</span> [</a>
<a class="sourceLine" id="cb21-8" title="8">        <span class="st">&quot;h&quot;</span>,</a>
<a class="sourceLine" id="cb21-9" title="9">        <span class="st">&quot;i&quot;</span></a>
<a class="sourceLine" id="cb21-10" title="10">    ]</a>
<a class="sourceLine" id="cb21-11" title="11">}</a></code></pre></div>
<p>Nice, it works!</p>
<p>Let’s explore the possibilities for a moment using a function for easily creating a overrides on the fly.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb22-1" title="1"><span class="ot">override ::</span> a <span class="ot">-&gt;</span> proxy xs <span class="ot">-&gt;</span> <span class="dt">Override</span> a xs</a>
<a class="sourceLine" id="cb22-2" title="2">override a _ <span class="fu">=</span> <span class="dt">Override</span> a</a></code></pre></div>
<p>This allows us to specify ad hoc overrides as a <code>proxy</code> and summon the appropriate instances as such. Let’s try it out!</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb23-1" title="1"><span class="fu">%</span> ghci</a>
<a class="sourceLine" id="cb23-2" title="2"><span class="fu">&gt;</span> <span class="fu">:</span>{</a>
<a class="sourceLine" id="cb23-3" title="3">    <span class="kw">data</span> <span class="dt">MyRec2</span> <span class="fu">=</span> <span class="dt">MyRec2</span></a>
<a class="sourceLine" id="cb23-4" title="4">      {<span class="ot"> foo ::</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb23-5" title="5">      ,<span class="ot"> bar ::</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb23-6" title="6">      ,<span class="ot"> baz ::</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb23-7" title="7">      } <span class="kw">deriving</span> stock (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Generic</span>)</a>
<a class="sourceLine" id="cb23-8" title="8">  <span class="fu">:</span>}</a>
<a class="sourceLine" id="cb23-9" title="9"></a>
<a class="sourceLine" id="cb23-10" title="10"><span class="fu">&gt;</span> r <span class="fu">=</span> <span class="dt">MyRec2</span> { foo <span class="fu">=</span> <span class="st">&quot;one&quot;</span>, bar <span class="fu">=</span> <span class="st">&quot;hi&quot;</span>, baz <span class="fu">=</span> <span class="st">&quot;bye&quot;</span> }</a></code></pre></div>
<p>No overrides will give us the default generically derived instance.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb24-1" title="1"><span class="fu">&gt;</span> enc <span class="fu">$</span> override r <span class="fu">$</span> <span class="dt">Proxy</span> <span class="fu">@</span>'[]</a>
<a class="sourceLine" id="cb24-2" title="2">{</a>
<a class="sourceLine" id="cb24-3" title="3">    <span class="st">&quot;foo&quot;</span><span class="fu">:</span> <span class="st">&quot;one&quot;</span>,</a>
<a class="sourceLine" id="cb24-4" title="4">    <span class="st">&quot;baz&quot;</span><span class="fu">:</span> <span class="st">&quot;bye&quot;</span>,</a>
<a class="sourceLine" id="cb24-5" title="5">    <span class="st">&quot;bar&quot;</span><span class="fu">:</span> <span class="st">&quot;hi&quot;</span></a>
<a class="sourceLine" id="cb24-6" title="6">}</a></code></pre></div>
<p>We can specify a single override as before.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb25-1" title="1"><span class="fu">&gt;</span> enc <span class="fu">$</span> override r <span class="fu">$</span> <span class="dt">Proxy</span> <span class="fu">@</span>'[<span class="dt">String</span> <span class="ot">`As`</span> <span class="dt">CharArray</span>]</a>
<a class="sourceLine" id="cb25-2" title="2">{</a>
<a class="sourceLine" id="cb25-3" title="3">    <span class="st">&quot;foo&quot;</span><span class="fu">:</span> [</a>
<a class="sourceLine" id="cb25-4" title="4">        <span class="st">&quot;o&quot;</span>,</a>
<a class="sourceLine" id="cb25-5" title="5">        <span class="st">&quot;n&quot;</span>,</a>
<a class="sourceLine" id="cb25-6" title="6">        <span class="st">&quot;e&quot;</span></a>
<a class="sourceLine" id="cb25-7" title="7">    ],</a>
<a class="sourceLine" id="cb25-8" title="8">    <span class="st">&quot;baz&quot;</span><span class="fu">:</span> [</a>
<a class="sourceLine" id="cb25-9" title="9">        <span class="st">&quot;b&quot;</span>,</a>
<a class="sourceLine" id="cb25-10" title="10">        <span class="st">&quot;y&quot;</span>,</a>
<a class="sourceLine" id="cb25-11" title="11">        <span class="st">&quot;e&quot;</span></a>
<a class="sourceLine" id="cb25-12" title="12">    ],</a>
<a class="sourceLine" id="cb25-13" title="13">    <span class="st">&quot;bar&quot;</span><span class="fu">:</span> [</a>
<a class="sourceLine" id="cb25-14" title="14">        <span class="st">&quot;h&quot;</span>,</a>
<a class="sourceLine" id="cb25-15" title="15">        <span class="st">&quot;i&quot;</span></a>
<a class="sourceLine" id="cb25-16" title="16">    ]</a>
<a class="sourceLine" id="cb25-17" title="17">}</a></code></pre></div>
<p>We can also specify an override for a single field and a default for all other fields matching a type.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb26-1" title="1"><span class="fu">&gt;</span> <span class="fu">:</span>{</a>
<a class="sourceLine" id="cb26-2" title="2">    <span class="kw">newtype</span> <span class="dt">Upstring</span> <span class="fu">=</span> <span class="dt">Upstring</span> {<span class="ot"> unUpstring ::</span> <span class="dt">String</span> }</a>
<a class="sourceLine" id="cb26-3" title="3"></a>
<a class="sourceLine" id="cb26-4" title="4">    <span class="kw">instance</span> <span class="dt">ToJSON</span> <span class="dt">Upstring</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb26-5" title="5">      toJSON <span class="fu">=</span> toJSON <span class="fu">.</span> <span class="fu">map</span> <span class="dt">Char</span><span class="fu">.toUpper</span> <span class="fu">.</span> unUpstring</a>
<a class="sourceLine" id="cb26-6" title="6">  <span class="fu">:</span>}</a>
<a class="sourceLine" id="cb26-7" title="7"></a>
<a class="sourceLine" id="cb26-8" title="8"><span class="fu">&gt;</span> enc <span class="fu">$</span> override r <span class="fu">$</span> <span class="dt">Proxy</span> <span class="fu">@</span>'[<span class="st">&quot;bar&quot;</span> <span class="ot">`As`</span> <span class="dt">CharArray</span>, <span class="dt">String</span> <span class="ot">`As`</span> <span class="dt">Upstring</span>]</a>
<a class="sourceLine" id="cb26-9" title="9">{</a>
<a class="sourceLine" id="cb26-10" title="10">    <span class="st">&quot;foo&quot;</span><span class="fu">:</span> <span class="st">&quot;ONE&quot;</span>,</a>
<a class="sourceLine" id="cb26-11" title="11">    <span class="st">&quot;baz&quot;</span><span class="fu">:</span> <span class="st">&quot;BYE&quot;</span>,</a>
<a class="sourceLine" id="cb26-12" title="12">    <span class="st">&quot;bar&quot;</span><span class="fu">:</span> [</a>
<a class="sourceLine" id="cb26-13" title="13">        <span class="st">&quot;h&quot;</span>,</a>
<a class="sourceLine" id="cb26-14" title="14">        <span class="st">&quot;i&quot;</span></a>
<a class="sourceLine" id="cb26-15" title="15">    ]</a>
<a class="sourceLine" id="cb26-16" title="16">}</a></code></pre></div>
<p>We can even tell a field to use its original instance, overriding the override!</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb27-1" title="1"><span class="fu">&gt;</span> enc <span class="fu">$</span> override r <span class="fu">$</span> <span class="dt">Proxy</span> <span class="fu">@</span>'[<span class="st">&quot;baz&quot;</span> <span class="ot">`As`</span> <span class="dt">String</span>, <span class="dt">String</span> <span class="ot">`As`</span> <span class="dt">Upstring</span>]</a>
<a class="sourceLine" id="cb27-2" title="2">{</a>
<a class="sourceLine" id="cb27-3" title="3">    <span class="st">&quot;foo&quot;</span><span class="fu">:</span> <span class="st">&quot;ONE&quot;</span>,</a>
<a class="sourceLine" id="cb27-4" title="4">    <span class="st">&quot;baz&quot;</span><span class="fu">:</span> <span class="st">&quot;bye&quot;</span>,</a>
<a class="sourceLine" id="cb27-5" title="5">    <span class="st">&quot;bar&quot;</span><span class="fu">:</span> <span class="st">&quot;HI&quot;</span></a>
<a class="sourceLine" id="cb27-6" title="6">}</a></code></pre></div>
<p>What if we get the types wrong? Is it safe? Yes!</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb28-1" title="1"><span class="fu">&gt;</span> enc <span class="fu">$</span> override r <span class="fu">$</span> <span class="dt">Proxy</span> <span class="fu">@</span>'[<span class="dt">String</span> <span class="ot">`As`</span> <span class="dt">Uptext</span>]</a></code></pre></div>
<pre class="text"><code>&lt;interactive&gt;:121:1: error:
    • Couldn't match representation of type ‘Text’
                               with that of ‘[Char]’
        arising from a use of ‘enc’
    • In the expression:
        enc $ override r $ Proxy @'[String `As` Uptext]
      In an equation for ‘it’:
          it = enc $ override r $ Proxy @'[String `As` Uptext]</code></pre>
<p>This also works for fields just as well.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb30-1" title="1"><span class="fu">&gt;</span> enc <span class="fu">$</span> override r <span class="fu">$</span> <span class="dt">Proxy</span> <span class="fu">@</span>'[<span class="st">&quot;bar&quot;</span> <span class="ot">`As`</span> <span class="dt">Uptext</span>]</a></code></pre></div>
<pre class="text"><code>&lt;interactive&gt;:122:1: error:
    • Couldn't match representation of type ‘Text’
                               with that of ‘[Char]’
        arising from a use of ‘enc’
    • In the expression: enc $ override r $ Proxy @'[&quot;bar&quot; `As` Uptext]
      In an equation for ‘it’:
          it = enc $ override r $ Proxy @'[&quot;bar&quot; `As` Uptext]</code></pre>
<p>There is one gotcha, however, and that is that you will want to supply field overrides <em>first</em> and type overrides <em>last</em>.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb32-1" title="1"><span class="fu">&gt;</span> enc <span class="fu">$</span> override r <span class="fu">$</span> <span class="dt">Proxy</span> <span class="fu">@</span>'[<span class="dt">String</span> <span class="ot">`As`</span> <span class="dt">Upstring</span>, <span class="st">&quot;bar&quot;</span> <span class="ot">`As`</span> <span class="dt">CharArray</span>]</a>
<a class="sourceLine" id="cb32-2" title="2">{</a>
<a class="sourceLine" id="cb32-3" title="3">    <span class="st">&quot;foo&quot;</span><span class="fu">:</span> <span class="st">&quot;ONE&quot;</span>,</a>
<a class="sourceLine" id="cb32-4" title="4">    <span class="st">&quot;baz&quot;</span><span class="fu">:</span> <span class="st">&quot;BYE&quot;</span>,</a>
<a class="sourceLine" id="cb32-5" title="5">    <span class="st">&quot;bar&quot;</span><span class="fu">:</span> <span class="st">&quot;HI&quot;</span></a>
<a class="sourceLine" id="cb32-6" title="6">}</a></code></pre></div>
<p>For those in which “just get it right” is not an acceptible solution, we could devise some sort of <code>ValidateOverride</code> type class that, upon attempting to do any sort of overriding, checks for situations like this and reports them as compiler errors. Or we could specialize the <code>Using</code> type family to prefer fields over types in overrides.</p>
<p>However, I think it’s always a good idea to test your codecs and instances anyway, especially when doing any sort of specialization, so until such machinery were implemented this is probably an acceptible gotcha to be aware of.</p>
<h2 id="thats-it-for-now">That’s it for now</h2>
<p>There’s still likely more exploration and work to be done in this area, but so far I’ve packaged up a workable library with tests and more examples: <a href="https://github.com/carymrobbins/generic-override/">generic-override</a>.</p>
<p>The library has not been officially published yet, but hopefully will be soon.</p>
    </div>
  </div>
  <div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = 'http://caryrobbins.com' + '/dev/overriding-type-class-instances-2/index.html';
this.page.identifier = '/dev/overriding-type-class-instances-2/index.html';
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://caryrobbins-com.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>

    </div>

    <footer class="footer">
      <hr />
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <a href="../../">Home</a>
          </div>
          <div class="col-md-6 text-right">
            Copyright © 2020
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>
